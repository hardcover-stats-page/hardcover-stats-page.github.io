{% extends "base.html" %}
{% block title %}Reading Dashboard{% endblock %}

{% macro stars(n) -%}
  {% if n %}
    <span class="stars" aria-label="{{n}} stars">
      {% for _ in range(n) %}★{% endfor %}
    </span>
  {% endif %}
{%- endmacro %}

{% block content %}

<header class="header">
  <div class="profile">
    {% if me.avatar %}
      <img class="avatar" src="{{ me.avatar }}" alt="Avatar">
    {% else %}
      <div class="avatar placeholder">?</div>
    {% endif %}

    <div class="profile-meta">
      <div class="profile-name">{{ me.name or "Reading Dashboard" }}</div>
      {% if me.username %}
        <div class="muted">{{ me.username }}</div>
      {% endif %}
      {% if me.profile_url %}
        <a class="link" href="{{ me.profile_url }}" target="_blank" rel="noreferrer">Hardcover Profile</a>
      {% endif %}
      <div class="muted small">Build: {{ build.stamp }}</div>
    </div>
  </div>

  <div class="stats">
    <div class="card">
      <div class="label">Goal</div>
      <div class="value">{{ stats.goal_progress or 0 }} / {{ stats.goal_total or 0 }}</div>
      <div class="muted">{{ "%.1f"|format(stats.goal_pct or 0) }}%</div>
    </div>

    <div class="card">
      <div class="label">Avg / Median days</div>
      <div class="value">{{ stats.avg_days or "–" }} / {{ stats.median_days or "–" }}</div>
      <div class="muted">
        Monthly streak<br>
        current {{ stats.streak_monthly_current or 0 }} · best {{ stats.streak_monthly_best or 0 }}
      </div>
    </div>

    <div class="card">
      <div class="label">All time totals</div>
      <div class="value">{{ totals.books }} books</div>
      <div class="muted">{{ totals.pages }} pages</div>
      {% if totals.missing_pages %}
        <div class="small muted">
          Note: {{ totals.missing_pages }} book(s) without page data are not counted in pages.
        </div>
      {% endif %}
    </div>

    <div class="card">
      <div class="label">Ø pace (so far)</div>
      <div class="value">Ø {{ stats.pace_pages_per_day or "–" }} pages / day</div>
      <div class="muted">Ø {{ stats.pace_books_per_month or "–" }} books / month</div>
    </div>
  </div>
</header>


<section class="section">
  <h2>Books per Year</h2>

  <div class="chart-wrap">
    <div class="bars">
      {% for row in books_per_year %}
        {% set h = (row.count / books_per_year_max * 100) if books_per_year_max > 0 else 0 %}
        <div class="barcol">
          <div class="bar" style="height: {{ h }}%"></div>
          <div class="barlabels">
            <div class="year">{{ row.year }}</div>
            <div class="count">{{ row.count }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>


<section class="section">
  <h2>Currently Reading</h2>

  <div class="grid">
    {% for b in currently %}
      <a class="bookcard" href="{{ b.hardcover_book_url }}" target="_blank" rel="noreferrer">
        <div class="cover">
          {% if b.cover %}
            <img src="{{ b.cover }}" alt="Cover">
          {% else %}
            <div class="nocover">No Cover</div>
          {% endif %}
        </div>

        <div class="bookmeta">
          <div class="title">{{ b.title }}</div>
          <div class="muted">{{ b.author }}</div>

          <div class="chips">
            {% if b.pages %}<span class="chip">{{ b.pages }} pages</span>{% endif %}
            {% if b.pct is not none %}<span class="chip">{{ b.pct }}%</span>{% endif %}
            {% if b.missing %}<span class="chip warn">missing data</span>{% endif %}
            {{ stars(b.rating_stars) }}
          </div>

          <div class="progress">
            <div class="progressline">
              <div class="progressfill" style="width: {{ b.pct if b.pct is not none else 0 }}%"></div>
            </div>
            <div class="progressmeta">
              {{ b.progress or 0 }} / {{ b.pages if b.pages else "?" }} pages ·
              {{ b.pct if b.pct is not none else 0 }}%
            </div>
          </div>
        </div>
      </a>
    {% endfor %}
  </div>
</section>


<section class="section">
  <h2>Timeline</h2>

  {% for y in timeline %}
    <div class="yearbox">
      <div class="yearhead">
        <div class="year">{{ y.year }}</div>
        <div class="muted">{{ y.count }} books</div>
      </div>

      <div class="timeline">
        <div class="line"></div>

        {% for m in y.months %}
          <div class="month">
            <div class="monthhead">
              {{ m.month_name }}
              <span class="muted">({{ m.count }})</span>
            </div>

            <div class="monthlist">
              {% for b in m.books %}
                <a class="row" href="{{ b.hardcover_book_url }}" target="_blank" rel="noreferrer">
                  <div class="dot"></div>

                  <div class="rowcover">
                    {% if b.cover %}
                      <img src="{{ b.cover }}" alt="Cover">
                    {% else %}
                      <div class="nocover small">No Cover</div>
                    {% endif %}
                  </div>

                  <div class="rowmeta">
                    <div class="title">{{ b.title }}</div>
                    <div class="muted">{{ b.author }}</div>

                    <div class="chips">
                      {% if b.pages %}<span class="chip">{{ b.pages }} pages</span>{% endif %}
                      {% if b.duration_days %}<span class="chip">{{ b.duration_days }} days</span>{% endif %}
                      {{ stars(b.rating_stars) }}
                      {% if b.missing %}<span class="chip warn">missing data</span>{% endif %}
                    </div>
                  </div>
                </a>
              {% endfor %}
            </div>

          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</section>

<footer class="footer muted">
  Build: {{ build.stamp }}
</footer>

{% endblock %}
